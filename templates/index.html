<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模擬Twitter環境</title>
    <style>
        /* --- Base Styles --- */
        :root {
            --twitter-blue: #1d9bf0;
            --twitter-border-color: #eff3f4;
            --text-primary: #0f1419;
            --text-secondary: #536471;
            --background-color: #ffffff;
            --stress-low: #4caf50;
            --stress-mid: #ff9800;
            --stress-high: #f44336;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: var(--background-color); 
            margin: 0; 
            padding: 0;
            color: var(--text-primary);
        }

        /* --- Header --- */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--twitter-border-color);
            padding: 10px 20px;
            box-sizing: border-box;
            z-index: 1000;
        }
        .header-content {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { 
            font-size: 1.2em; 
            font-weight: bold;
            color: var(--text-primary); 
            margin: 0; 
        }
        .timer { 
            font-size: 1.2em; 
            font-weight: bold; 
            color: var(--text-primary); 
            min-width: 60px;
            text-align: right;
        }

        /* --- Main Container & Cards --- */
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 80px 0 20px 0;
        }
        .card { 
            background-color: #fff; 
            padding: 30px; 
            border-radius: 16px; 
            margin: 0 20px 20px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            text-align: center;
        }
        .card h2 { margin-top: 0; font-size: 1.5em; }
        .card p { color: var(--text-secondary); }
        .card input[type="text"] {
            width: 80%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
        }
        .card .button-group button { 
            width: 90px; 
            margin: 10px; 
            font-size: 16px;
            padding: 12px;
        }
        button { 
            display: inline-block; 
            padding: 12px 20px; 
            font-size: 16px; 
            font-weight: bold; 
            color: #fff; 
            background-color: var(--twitter-blue); 
            border: none; 
            border-radius: 9999px; /* Pill shape */
            cursor: pointer; 
            margin: 5px; 
            transition: background-color 0.2s;
        }
        button:hover { background-color: #1a8cd8; }
        
        /* --- Timeline --- */
        #status { 
            text-align: center; 
            margin: 15px 0; 
            color: var(--text-secondary); 
            font-style: italic; 
        }
        .timeline-container { 
            border-left: 1px solid var(--twitter-border-color);
            border-right: 1px solid var(--twitter-border-color);
        }
        #loading { 
            text-align: center; 
            padding: 30px; 
            font-style: italic; 
            color: #888; 
            display: none; 
        }

        /* --- Tweet Component (X/Twitter Style) --- */
        .tweet { 
            display: flex;
            padding: 15px; 
            border-bottom: 1px solid var(--twitter-border-color); 
            animation: fadeIn 0.5s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .tweet::before { /* Stress level indicator */
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
        }
        .tweet-Low::before { background-color: var(--stress-low); }
        .tweet-Mid::before { background-color: var(--stress-mid); }
        .tweet-High::before { background-color: var(--stress-high); }

        .tweet-icon {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            background-color: #ddd;
            border-radius: 50%;
            margin-right: 12px;
            margin-left: 8px; /* Space for indicator */
        }
        .tweet-content {
            flex-grow: 1;
        }
        .tweet-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        .tweet-user-name {
            font-weight: bold;
            margin-right: 5px;
        }
        .tweet-user-id {
            color: var(--text-secondary);
        }
        .tweet-text { 
            margin: 0 0 12px 0; 
            font-size: 15px; 
            line-height: 1.6; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
        }
        .tweet-actions {
            display: flex;
            justify-content: space-between;
            max-width: 425px;
            color: var(--text-secondary);
        }
        .tweet-actions div {
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: color 0.2s;
        }
        .tweet-actions svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }
        .tweet-actions div:hover { color: var(--twitter-blue); }

        /* --- Survey Modal --- */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 2000; 
        }
        .survey-modal { 
            background-color: #fff; 
            padding: 20px 30px; 
            border-radius: 16px; 
            width: 90%; 
            max-width: 500px; 
            text-align: center; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .survey-modal h2 { margin-top: 0; }
        .vas-container { 
            position: relative;
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            margin: 20px 0; 
        }
        .vas-container span { 
            font-size: 14px; 
            color: #666; 
        }
        #stressSlider { 
            flex-grow: 1; 
            margin: 0 15px; 
        }
        #stressValueDisplay { 
            font-size: 2em; 
            font-weight: bold; 
            color: var(--twitter-blue); 
            margin-bottom: 15px; 
        }
        #submitSurveyBtn { 
            background-color: #28a745;
        }
        #submitSurveyBtn:hover {
            background-color: #218838;
        }
        #last-response-marker {
            position: absolute;
            top: -10px;
            width: 2px;
            height: 20px;
            background-color: red;
            transform: translateX(-50%);
            display: none;
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-content">
            <h1>模擬タイムライン実験</h1>
            <div id="timer" class="timer">--:--</div>
        </div>
    </div>

    <div class="container">
        <div id="name-screen" class="card">
            <h2>参加者のお名前を入力してください</h2>
            <input type="text" id="userNameInput" placeholder="お名前">
            <button id="start-button">実験を開始</button>
        </div>

        <div id="condition-screen" class="card" style="display: none;">
            <h2>ストレス密度を選択してください</h2>
            <p>実験は合計で約17分間かかります。</p>
            <div class="button-group">
                <button onclick="startExperiment(0)">0%</button>
                <button onclick="startExperiment(25)">25%</button>
                <button onclick="startExperiment(50)">50%</button>
                <button onclick="startExperiment(70)">70%</button>
            </div>
        </div>

        <div id="main-content" style="display: none;">
            <div id="status"></div>
            <div id="loading">読み込み中...</div>
            <div class="timeline-container" id="timeline-container"></div>
        </div>

        <div id="survey-overlay" class="modal-overlay" style="display: none;">
            <div class="survey-modal">
                <h2 id="survey-title">ストレスレベルを評価してください</h2>
                <p>現在のストレスレベルを0（全く感じない）から100（非常に強く感じる）で評価してください。</p>
                <div id="stressValueDisplay">50</div>
                <div class="vas-container">
                    <span>0</span>
                    <input type="range" id="stressSlider" min="0" max="100" value="50">
                    <span>100</span>
                    <div id="last-response-marker"></div>
                </div>
                <button id="submitSurveyBtn">回答する</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:5000';
        
        // DOM Elements
        const timelineContainer = document.getElementById('timeline-container');
        const statusDisplay = document.getElementById('status');
        const loadingIndicator = document.getElementById('loading');
        const surveyOverlay = document.getElementById('survey-overlay');
        const surveyTitle = document.getElementById('survey-title');
        const timerDisplay = document.getElementById('timer');
        const stressSlider = document.getElementById('stressSlider');
        const stressValueDisplay = document.getElementById('stressValueDisplay');
        const submitSurveyBtn = document.getElementById('submitSurveyBtn');
        const startScreen = document.getElementById('condition-screen');
        const nameScreen = document.getElementById('name-screen');
        const mainContent = document.getElementById('main-content');
        const startButton = document.getElementById('start-button');
        const userNameInput = document.getElementById('userNameInput');
        const lastResponseMarker = document.getElementById('last-response-marker');

        // State variables
        let isLoading = false;
        let chosenProbability = 0;
        let currentProbability = 0;
        let actualProbability = 0;
        let sessionId = Date.now().toString(36) + Math.random().toString(36).substr(2);
        let userName = '';
        let intervalCount = 0;
        let timerInterval;
        let timeLeft;
        let onTimerEnd;
        let experimentState = 'name_entry';
        let lastStressLevel = null;

        // --- Event Listeners ---
        stressSlider.addEventListener('input', () => {
            stressValueDisplay.textContent = stressSlider.value;
        });

        startButton.addEventListener('click', () => {
            userName = userNameInput.value.trim();
            if (userName === "") {
                alert("お名前を入力してください。");
                return;
            }
            nameScreen.style.display = 'none';
            startScreen.style.display = 'block';
            experimentState = 'condition_select';
        });

        window.addEventListener('scroll', () => {
            if ((experimentState === 'warmup' || experimentState === 'main_experiment') && !isLoading) {
                if ((window.innerHeight + window.scrollY) >= document.documentElement.scrollHeight - 500) {
                    fetchAndRenderTimeline(false, currentProbability);
                }
            }
        });

        // --- Experiment Flow Control ---
        function startExperiment(targetPercentage) {
            chosenProbability = targetPercentage / 100.0;
            startScreen.style.display = 'none';
            mainContent.style.display = 'block';
            
            console.log(`実験開始: ストレス密度 ${targetPercentage}%`);
            runNextPhase();
        }

        async function runNextPhase() {
            intervalCount++;
            console.log(`フェーズ: ${intervalCount}`);
            
            switch(intervalCount) {
                case 1: // 事前アンケート
                    await showSurvey("実験開始前の状態を評価してください", 0);
                    runNextPhase();
                    break;
                case 2: // 準備運動フェーズ
                    experimentState = 'warmup';
                    statusDisplay.textContent = 'ウォーミングアップ中 (2分間)';
                    currentProbability = 0;
                    timelineContainer.innerHTML = '';
                    await fetchAndRenderTimeline(true, 0);
                    startTimer(120, runNextPhase); // 2分 = 120秒
                    break;
                case 3: // 準備運動後のアンケート
                    await showSurvey("ウォーミングアップ後の状態を評価してください", 1);
                    runNextPhase();
                    break;
                case 4: // 本番フェーズ1
                    experimentState = 'main_experiment';
                    currentProbability = chosenProbability;
                    statusDisplay.textContent = `実験中 (目標ストレス: ${Math.round(chosenProbability * 100)}%) - 1/3`;
                    timelineContainer.innerHTML = '';
                    await fetchAndRenderTimeline(true, currentProbability);
                    startTimer(300, runNextPhase); // 5分 = 300秒
                    break;
                case 5: // 本番フェーズ1後のアンケート
                    await showSurvey(`アンケート (1/3)`, 2);
                    runNextPhase();
                    break;
                case 6: // 本番フェーズ2
                    experimentState = 'main_experiment';
                    statusDisplay.textContent = `実験中 (目標ストレス: ${Math.round(chosenProbability * 100)}%) - 2/3`;
                    await fetchAndRenderTimeline(true, currentProbability);
                    startTimer(300, runNextPhase);
                    break;
                case 7: // 本番フェーズ2後のアンケート
                    await showSurvey(`アンケート (2/3)`, 3);
                    runNextPhase();
                    break;
                case 8: // 本番フェーズ3
                    experimentState = 'main_experiment';
                    statusDisplay.textContent = `実験中 (目標ストレス: ${Math.round(chosenProbability * 100)}%) - 3/3`;
                    await fetchAndRenderTimeline(true, currentProbability);
                    startTimer(300, runNextPhase);
                    break;
                case 9: // 最終アンケート
                    await showSurvey(`アンケート (3/3)`, 4);
                    runNextPhase();
                    break;
                default: // 終了
                    experimentState = 'finished';
                    statusDisplay.textContent = '実験終了です。ご協力ありがとうございました。';
                    clearInterval(timerInterval);
                    timerDisplay.textContent = "終了";
                    timelineContainer.innerHTML = '<h2 style="text-align:center; color:#28a745; padding: 50px;">実験は終了しました。ブラウザを閉じてください。</h2>';
            }
        }

        // --- Timer Logic ---
        function startTimer(duration, callback) {
            timeLeft = duration;
            onTimerEnd = callback;
            updateTimerDisplay();
            resumeTimer();
        }

        function pauseTimer() {
            clearInterval(timerInterval);
        }

        function resumeTimer() {
            if (experimentState === 'finished') return;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    onTimerEnd();
                    return;
                }
                updateTimerDisplay();
                timeLeft--;
            }, 1000);
        }

        function updateTimerDisplay() {
            if (timeLeft < 0) return;
            const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
            const seconds = String(timeLeft % 60).padStart(2, '0');
            timerDisplay.textContent = `${minutes}:${seconds}`;
        }

        // --- Survey Logic ---
        function showSurvey(title, intervalId) {
            return new Promise(resolve => {
                pauseTimer();
                experimentState = 'survey';
                surveyTitle.textContent = title;
                
                if (lastStressLevel !== null) {
                    lastResponseMarker.style.left = `${lastStressLevel}%`;
                    lastResponseMarker.style.display = 'block';
                } else {
                    lastResponseMarker.style.display = 'none';
                }

                surveyOverlay.style.display = 'flex';
                
                submitSurveyBtn.onclick = () => {
                    const stressLevel = stressSlider.value;
                    lastStressLevel = stressLevel;
                    sendSurveyData(stressLevel, intervalId);
                    surveyOverlay.style.display = 'none';
                    stressSlider.value = 50;
                    stressValueDisplay.textContent = '50';
                    
                    if (intervalId === 0) {
                        experimentState = 'warmup';
                    } else {
                        experimentState = 'main_experiment';
                    }
                    
                    if (timeLeft >= 0) {
                        resumeTimer();
                    }
                    
                    resolve();
                };
            });
        }

        async function sendSurveyData(stressLevel, intervalNum) {
            const intervalMap = {
                0: "pre_experiment",
                1: "post_warmup",
                2: "5_min",
                3: "10_min",
                4: "15_min"
            };
            const now = new Date();
            const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

            const data = {
                sessionId: sessionId,
                userName: userName,
                targetProbability: chosenProbability,
                actualProbability: actualProbability,
                interval: intervalMap[intervalNum] || `interval_${intervalNum}`,
                stressLevel: stressLevel,
                timestamp: timestamp
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/save_survey`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                if (!response.ok) {
                    throw new Error('サーバーへのデータ送信に失敗しました。');
                }
                console.log('Survey data sent:', data);
            } catch (error) {
                console.error('Error sending survey data:', error);
                statusDisplay.textContent = 'アンケートデータの保存に失敗しました。';
            }
        }

        // --- Timeline Fetching and Rendering ---
        async function fetchAndRenderTimeline(isNewSearch = false, probability) {
            if (isLoading) return;
            isLoading = true;

            const apiUrl = `${API_BASE_URL}/api/timeline?probability=${probability * 100}`;

            if (isNewSearch) {
                loadingIndicator.style.display = 'block';
            }

            try {
                console.log(`投稿取得: probability=${probability * 100}%`);
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`サーバーエラー: ${response.status} ${response.statusText}`);
                
                const data = await response.json();
                console.log('API Response:', data);
                
                if (data.success) {
                    actualProbability = data.actual_probability;
                    if (isNewSearch) {
                        timelineContainer.innerHTML = '';
                    }
                    renderTimeline(data.timeline);
                } else {
                    throw new Error(data.message || '不明なエラーが発生しました。');
                }
            } catch (error) {
                console.error('APIエラー:', error);
                statusDisplay.textContent = `エラー: タイムラインの取得に失敗しました。${error.message}`;
                if (isNewSearch && timelineContainer.children.length === 0) {
                    timelineContainer.innerHTML = `<p style="color:red; text-align:center; padding:20px;">${error.message}</p>`;
                }
            } finally {
                isLoading = false;
                loadingIndicator.style.display = 'none';
            }
        }

        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★★★ UI変更の核となる部分です。投稿のHTML構造をX風に変更しました。 ★★★
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        function renderTimeline(timelineData) {
            console.log(`投稿をレンダリング: ${timelineData.length}件`);
            
            if (!timelineData || timelineData.length === 0) {
                console.warn('投稿データが空です');
                if (timelineContainer.children.length === 0) {
                    timelineContainer.innerHTML = '<p style="text-align:center; padding:20px;">投稿がありません。</p>';
                }
                return;
            }

            const fragment = document.createDocumentFragment();
            timelineData.forEach((tweet) => {
                const tweetDiv = document.createElement('div');
                tweetDiv.className = 'tweet';
                
                // Set stress level class for the side border
                if (tweet.stress <= 0.1) {
                    tweetDiv.classList.add('tweet-Low');
                } else if (tweet.stress > 0.1 && tweet.stress < 0.7) {
                    tweetDiv.classList.add('tweet-Mid');
                } else {
                    tweetDiv.classList.add('tweet-High');
                }

                // Sanitize tweet text to prevent HTML injection
                const sanitizedText = document.createElement('div');
                sanitizedText.textContent = tweet.text || '（投稿テキストなし）';

                // Using template literal for cleaner HTML structure
                tweetDiv.innerHTML = `
                    <div class="tweet-icon"></div>
                    <div class="tweet-content">
                        <div class="tweet-header">
                            <span class="tweet-user-name">匿名ユーザー</span>
                            <span class="tweet-user-id">@anonymous_user</span>
                        </div>
                        <p class="tweet-text">${sanitizedText.innerHTML}</p>
                        <div class="tweet-actions">
                            <div>
                                <svg viewBox="0 0 24 24"><g><path d="M1.751 10.246c0-1.264.383-2.494 1.09-3.562.706-1.068 1.706-1.93 2.89-2.506C6.918 3.59 8.266 3.25 9.68 3.25c1.13 0 2.22.24 3.22.72.99.47 1.84.98 2.53 1.5l-1.23 1.54c-.54-.42-1.14-.8-1.8-1.1-.66-.3-1.38-.45-2.15-.45-1.03 0-1.98.23-2.82.68-.84.45-1.55 1.08-2.1 1.86-.55.78-.83 1.74-.83 2.86s.28 2.08.83 2.86c.55.78 1.26 1.41 2.1 1.86.84.45 1.79.68 2.82.68.77 0 1.49-.15 2.15-.45.66-.3 1.26-.68 1.8-1.1l1.23 1.54c-.69.52-1.54 1.03-2.53 1.5-1 .48-2.09.72-3.22.72-1.414 0-2.762-.34-3.95-1.024-1.184-.676-2.184-1.538-2.89-2.606-.707-1.068-1.09-2.298-1.09-3.562zM22.25 12c0 1.264-.383 2.494-1.09 3.562-.706 1.068-1.706 1.93-2.89 2.506-1.188.58-2.536.92-3.95.92-1.13 0-2.22-.24-3.22-.72-.99-.47-1.84-.98-2.53-1.5l1.23-1.54c.54.42 1.14.8 1.8 1.1.66.3 1.38.45 2.15.45 1.03 0 1.98-.23 2.82-.68.84.45 1.55-1.08 2.1-1.86.55-.78.83-1.74.83-2.86s-.28-2.08-.83-2.86c-.55-.78-1.26-1.41-2.1-1.86-.84-.45-1.79-.68-2.82-.68-.77 0-1.49-.15-2.15-.45-.66-.3-1.26-.68-1.8-1.1l-1.23-1.54c.69-.52 1.54-1.03 2.53-1.5 1-.48 2.09-.72 3.22-.72 1.414 0 2.762.34 3.95 1.024 1.184.676 2.184 1.538 2.89 2.606.707 1.068 1.09 2.298 1.09 3.562z"></path></g></svg>
                            </div>
                            <div>
                                <svg viewBox="0 0 24 24"><g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g></svg>
                            </div>
                            <div>
                                <svg viewBox="0 0 24 24"><g><path d="M12 21.638h-.014C9.403 21.59 1.95 14.856 1.95 8.478c0-3.064 2.525-5.754 5.403-5.754 2.29 0 3.83 1.58 4.646 2.73.814-1.148 2.354-2.73 4.645-2.73 2.88 0 5.404 2.69 5.404 5.754 0 6.376-7.454 13.11-10.037 13.157H12zM7.354 4.225c-2.08 0-3.903 1.988-3.903 4.253 0 5.46 6.853 11.798 8.55 11.798.157 0 8.548-6.336 8.548-11.798 0-2.265-1.823-4.253-3.902-4.253-1.984 0-3.326 1.615-4.087 2.597-.18.24-.46.384-.76.384-.3 0-.58-.144-.76-.384-.76-1.03-2.102-2.597-4.086-2.597z"></path></g></svg>
                            </div>
                            <div>
                                <svg viewBox="0 0 24 24"><g><path d="M12 2.59l5.7 5.7-1.41 1.42L13 6.41V16h-2V6.41l-3.3 3.3-1.41-1.42L12 2.59zM21 15l-.02 3.51c0 1.38-1.12 2.49-2.5 2.49H5.5C4.12 21 3 19.88 3 18.51V15h2v3.5c0 .28.22.5.5.5h12.98c.28 0 .5-.22.5-.5V15h2z"></path></g></svg>
                            </div>
                        </div>
                    </div>
                `;
                
                fragment.appendChild(tweetDiv);
            });
            
            timelineContainer.appendChild(fragment);
            console.log(`${timelineData.length}件の投稿を表示しました`);
        }
    </script>
</body>
</html>